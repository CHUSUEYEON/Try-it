<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Coupon Notifications</title>
  <style>
    h1{
      text-align: center;
    }

    #notificationsList {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .notification {
      width: 50%;
      border: 1px solid #ddd;
      padding: 10px;
      margin: 5px;
      border-radius: 5px;
      background-color: #f9f9f9;
    }

    .notification .alarm{
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      position: relative;
      z-index: 1;
    }

    .date{
      margin-right: 10px;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ë°°ê²½ */
      justify-content: center;
      align-items: center;
      z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
    }

    .modal-content {
      background-color: #fff;
      margin: 10% auto; /* 50% ìœ„ì¹˜ */
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2{
      text-align: center;
    }

    .content {
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
      text-align: center;
     }


     .dateP {
      margin-bottom: 10px;
      font-size: 12px;
      }

    .modal-header, .modal-body, .modal-footer {
      margin-bottom: 15px;
    }

    .modal-close {
      cursor: pointer;
      float: right;
      font-size: 20px;
    }

    .modal-close:hover {
      color: red;
    }

  </style>
</head>
<body>
  <h1>Coupon Notifications</h1>
  <div id="notificationsList">
    <!-- ì•ŒëŒ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë¨ -->
  </div>
  <div id="myModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <h2 id="modalTitle"></h2>
      <div class="content">
        <p id="modalContent"></p>
        <p class="dateP"><strong>Received Date:</strong> <span id="modalDate"></span></p>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

    // ëª¨ë‹¬ ìš”ì†Œ ì°¸ì¡°
    const modal = document.getElementById('myModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('modalContent');
    const modalDate = document.getElementById('modalDate');
    const closeModalBtn = document.getElementsByClassName('modal-close')[0];

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° SSE ì—°ê²° ì„¤ì •
    function checkLoginStatus() {
        const token = localStorage.getItem('jwtToken');
        if (token) {
            connectToNotifications();
            getAlarmsList(token);
        }
    }

    // ì•ŒëŒ ëª©ë¡ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
      async function getAlarmsList(token) {
        try {
          const response = await axios.get('/users/notifications', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });
          if (response.status === 200 && response.data.data) {
            const alarms = response.data.data;
            displayAlarms(alarms);
          }
        } catch (error) {
          console.error('Failed to fetch alarms:', error);
        }
      }

      // ì•ŒëŒ ëª©ë¡ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
      function displayAlarms(alarms) {
        const notificationsList = document.getElementById('notificationsList');
        notificationsList.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

        alarms.forEach(alarm => {
          const alarmDiv = document.createElement('div');
          const formattedDate = alarm.alarmCreatedAt.substring(0, 10)
          alarmDiv.classList.add('notification');
          alarmDiv.innerHTML = `
            <div class = "alarm">
            <span><strong>Title:</strong> ${alarm.alarmTitle} </span>
            <span><span class="date">${formattedDate}</span>
            ${alarm.alarmIsRead === true ? 'ì½ìŒ' : '<span style="color:red; text-align: right;">1</span>'}
            </span>
            </div>
          `;
            // í´ë¦­í•˜ë©´ ëª¨ë‹¬ì´ ì—´ë¦¬ë„ë¡ ì„¤ì •
            alarmDiv.addEventListener('click', () => {
           console.log('Alarm clicked:', alarm.alarmTitle);  // ë¡œê·¸ë¡œ í´ë¦­ í™•ì¸
            openModal(alarm);
            });

          notificationsList.appendChild(alarmDiv);
        });
      }

      // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
      function openModal(alarm) {
      console.log('Opening modal for:', alarm.alarmTitle);
      // \nì„ <br>ë¡œ ë³€í™˜
        const formattedContent = alarm.alarmContent.replace(/\n/g, '<br>');

        modalTitle.textContent = alarm.alarmTitle;
        modalContent.innerHTML = `${formattedContent}`;
        modalDate.textContent = alarm.alarmCreatedAt.substring(0, 10);
        modal.style.display = "block";
      }

      // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
      closeModalBtn.onclick = function() {
        modal.style.display = "none";
      }

      // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
      window.onclick = function(event) {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      }


    // SSE ì—°ê²° í•¨ìˆ˜
    function connectToNotifications() {
        const token = localStorage.getItem('jwtToken');
        const eventSource = new EventSource(`/users/notifications/connect?token=${token}`);

        eventSource.addEventListener('sse', function(event) {
            if (typeof event.data === 'string' && !event.data.startsWith('EventStream')) {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    console.error('Failed to parse event data:', e);
                    return;
                }

                if (data.alarmTitle) {
                    alert(`[${data.alarmTitle}]ì´ ë„ì°©í–ˆì–´ìš”~~~ğŸ˜˜ \nì¿ í°í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!`);
                } else {
                    console.error('alarmTitle not found in event data');
                }
            }
        });

        eventSource.onerror = function(error) {
            console.error('SSE connection error:', error);
            eventSource.close(); // ì—ëŸ¬ ì‹œ SSE ì—°ê²° ë‹«ê¸°
        };
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    checkLoginStatus();
});

  </script>

</body>
</html>