<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>pay</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 70%;
      margin: 50px auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1, h2 {
      color: #333;
      font-weight: 600;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 10px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }

    .order-section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #5b9bd5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    thead {
      background-color: #f2f2f2;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
    }

    td {
      color: #555;
    }

    tbody tr:hover {
      background-color: #f9f9f9;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #45a049;
    }

    p {
      font-size: 18px;
      color: #333;
    }

    p span {
      font-weight: bold;
      color: #e74c3c;
    }
  </style>
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
  <div class="container">
    <h1>주문 정보</h1>

    <div class="order-section">
      <h2>배송 정보</h2>
      <form id="paymentForm">
        <label for="recipient">수령인:</label>
        <input type="text" id="recipient" name="orderRecipient" required>

        <label for="address">주소:</label>
        <input type="text" id="address" name="orderAddress" required>

        <label for="phone">전화번호:</label>
        <input type="tel" id="phone" name="orderPhone" required>

        <label for="request">배송 요청사항:</label>
        <textarea id="request" name="orderRequest" rows="3" cols="40"></textarea>
      </form>
    </div>

    <div class="order-section">
      <h2>주문 상품</h2>
      <table>
        <thead>
        <tr>
          <th>상품명</th>
          <th>수량</th>
          <th>가격</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <hr>
      <p>총 주문 금액: <span id="totalPrice">500</span></p>
      <p>쿠폰: <span id="coupon"></span> </p>
    </div>

    <div class="order-section">
      <h2>결제</h2>
      <button type="button" id="orderBtn">결제하기</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('jwtToken');
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

      const axiosInstance = axios.create({withCredentials: true}); // 세션값을 저장하고 사용하기 위해 호출

    async function completeOrder(){
      try{
        const response = await axios.post('http://localhost:8080/orders/goods',{
        orderAddress : document.getElementById("address").value,
        orderPhone : document.getElementById("phone").value,
        orderRecipient : document.getElementById("recipient").value,
<!--        orderTotal : document.getElementById("totalPrice").value,-->
<!--        coupon : document.getElementById("coupon").value,-->
        orderRequest : document.getElementById("request").value
        });
        console.log(response.data);
        requestPay(response.data);
        } catch(error){
          console.error("completeOrder error: ",error);
        }
    }

      // 결제 기능
      var IMP = window.IMP;
      IMP.init("imp38754276");

      function requestPay(orderInfo) {
        IMP.request_pay(
          {
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: "122344343",
            name: "test",
            amount: "100",
            buyer_email: "gildong@gmail.com",
            buyer_name: orderInfo.orderName,
            buyer_tel: orderInfo.orderPhone,
            buyer_addr: orderInfo.orderAddress,
<!--            buyer_postcode: "01181"-->
          },
          function (rsp) {
            if (rsp.success) {
            const token = localStorage.getItem('jwtToken');
            const data = JSON.stringify({
                    imp_uid: rsp.imp_uid,
                    merchant_uid: rsp.merchant_uid,
                    amount :rsp.paid_amount,
                    order : 38,
                    goods : 3
                  })
                  console.log("----------"+data);
              $.ajax({
                  url: "/order/payment/" + rsp.imp_uid,
                  method: 'POST',
                  contentType: 'application/json',
                  headers: {
                  'Authorization': `Bearer ${token}`
                  },
                  data,
                  }).done(function(data){
                  console.log(data);
                  alert("결제 성공");
<!--                  window.location.href = "/payment/success";-->
                 })
            } else {
              alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
            }
          }
        );
      }

      // 결제 버튼 클릭 이벤트
      document.getElementById('orderBtn').addEventListener('click', completeOrder);

      // 로그인 상태 확인 및 SSE 연결 설정
      function checkLoginStatus() {
        if (token) {
          connectToNotifications(token);
          console.log(token);
        }
      }

      // SSE 연결 함수
      function connectToNotifications(token) {
        const eventSource = new EventSource(`/users/notifications/connect?token=${token}`);

        eventSource.addEventListener('sse', function (event) {
          if (typeof event.data === 'string' && !event.data.startsWith('EventStream')) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              console.error('Failed to parse event data:', e);
              return;
            }

            if (data.alarmTitle) {
              alert(`[${data.alarmTitle}]이 도착했어요~~~😘 \n쿠폰함을 확인해주세요!`);
            } else {
              console.error('alarmTitle not found in event data');
            }
          }
        });

        eventSource.onerror = function (error) {
          console.error('SSE connection error:', error);
          eventSource.close();
        };
      }

      // 페이지 로드 시 로그인 상태 확인
      checkLoginStatus();
    });
  </script>
</body>
</html>
