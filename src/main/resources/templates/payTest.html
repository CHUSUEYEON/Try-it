<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>pay</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 70%;
      margin: 50px auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1, h2 {
      color: #333;
      font-weight: 600;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 10px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }

    .order-section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #5b9bd5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    thead {
      background-color: #f2f2f2;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
    }

    td {
      color: #555;
    }

    tbody tr:hover {
      background-color: #f9f9f9;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #45a049;
    }

    p {
      font-size: 18px;
      color: #333;
    }

    p span {
      font-weight: bold;
      color: #e74c3c;
    }
  </style>
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
  <div class="container">
    <h1>ì£¼ë¬¸ ì •ë³´</h1>

    <div class="order-section">
      <h2>ë°°ì†¡ ì •ë³´</h2>
      <form id="paymentForm">
        <label for="recipient">ìˆ˜ë ¹ì¸:</label>
        <input type="text" id="recipient" name="orderRecipient" required>

        <label for="address">ì£¼ì†Œ:</label>
        <input type="text" id="address" name="orderAddress" required>

        <label for="phone">ì „í™”ë²ˆí˜¸:</label>
        <input type="tel" id="phone" name="orderPhone" required>

        <label for="request">ë°°ì†¡ ìš”ì²­ì‚¬í•­:</label>
        <textarea id="request" name="orderRequest" rows="3" cols="40"></textarea>
      </form>
    </div>

    <div class="order-section">
      <h2>ì£¼ë¬¸ ìƒí’ˆ</h2>
      <table>
        <thead>
        <tr>
          <th>ìƒí’ˆëª…</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ê°€ê²©</th>
        </tr>
        <!--  TODO : ì„œë²„ì—ì„œ ë„˜ê²¨ì¤€ ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§. Thymeleaf ì´ìš©  -->
        </thead>
        <tbody>
        </tbody>
      </table>
      <hr>
      <p>ì´ ì£¼ë¬¸ ê¸ˆì•¡: <span id="totalPrice">500</span></p>
      <p>ì¿ í°: <span id="coupon"></span> </p>
    </div>

    <div class="order-section">
      <h2>ê²°ì œ</h2>
      <button type="button" id="orderBtn">ê²°ì œí•˜ê¸°</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('jwtToken');
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

      const axiosInstance = axios.create({withCredentials: true}); // ì„¸ì…˜ê°’ì„ ì €ì¥í•˜ê³  ì‚¬ìš©í•˜ê¸° ìœ„í•´ í˜¸ì¶œ

    async function completeOrder(){
      try{
        const response = await axios.post('http://localhost:8080/orders/goods',{
        orderAddress : document.getElementById("address").value,
        orderPhone : document.getElementById("phone").value,
        orderRecipient : document.getElementById("recipient").value,
        // orderTotal : document.getElementById("totalPrice").value,
        // coupon : document.getElementById("coupon").value,
        orderRequest : document.getElementById("request").value
        });
        console.log(response.data);
        requestPay(response.data);
        } catch(error){
          console.error("completeOrder error: ",error);
        }
    }

      // ê²°ì œ ê¸°ëŠ¥
      var IMP = window.IMP;
      IMP.init("imp38754276");

      const usedMerchantUids = new Set(); // Setì„ ì´ìš©í•´ ì¤‘ë³µ ë°©ì§€

      function generateUniqueRandomNumber(minLength = 8, maxLength = 10){
        let randomNumber;

        do{
          const length = Math.floor(Math.random() * (maxLength - minLength + 1)) + minLength;
          randomNumber = "";

          for(let i = 0; i < length; i++){
            randomNumber += Math.floor(Math.random() * 10);
          }
        } while (usedMerchantUids.has(randomNumber));

        usedMerchantUids.add(randomNumber);
        return randomNumber;
      }



      function requestPay(orderInfo) {

        const randomMerchantUid = generateUniqueRandomNumber();

        IMP.request_pay(
          {
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: randomMerchantUid,
            name: "test",
            amount: "100",
            buyer_email: "gildong@gmail.com",
            buyer_name: orderInfo.orderName,
            buyer_tel: orderInfo.orderPhone,
            buyer_addr: orderInfo.orderAddress,
<!--            buyer_postcode: "01181"-->
          },
          function (rsp) {
            if (rsp.success) {
            const token = localStorage.getItem('jwtToken');
            const data = JSON.stringify({
                    imp_uid: rsp.imp_uid,
                    merchant_uid: rsp.merchant_uid,
                    amount :rsp.paid_amount,
                    order : 38,
                    goods : 3
                  })
                  console.log("----------"+data);
              $.ajax({
                  url: "/order/payment",
                  method: 'POST',
                  contentType: 'application/json',
                  headers: {
                  'Authorization': `Bearer ${token}`
                  },
                  data,
                  }).done(function(data){
                  console.log(data);
                  alert("ê²°ì œ ì„±ê³µ");
                  /* window.location.href = "/payment/success"; */
                 })
            } else {
              alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " + rsp.error_msg);
            }
          }
        );
      }

      // ê²°ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById('orderBtn').addEventListener('click', completeOrder);

      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° SSE ì—°ê²° ì„¤ì •
      function checkLoginStatus() {
        if (token) {
          connectToNotifications(token);
          console.log(token);
        }
      }

      // SSE ì—°ê²° í•¨ìˆ˜
      function connectToNotifications(token) {
        const eventSource = new EventSource(`/users/notifications/connect?token=${token}`);

        eventSource.addEventListener('sse', function (event) {
          if (typeof event.data === 'string' && !event.data.startsWith('EventStream')) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              console.error('Failed to parse event data:', e);
              return;
            }

            if (data.alarmTitle) {
              alert(`[${data.alarmTitle}]ì´ ë„ì°©í–ˆì–´ìš”~~~ğŸ˜˜ \nì¿ í°í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!`);
            } else {
              console.error('alarmTitle not found in event data');
            }
          }
        });

        eventSource.onerror = function (error) {
          console.error('SSE connection error:', error);
          eventSource.close();
        };
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      checkLoginStatus();
    });
  </script>
</body>
</html>
