<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>pay</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      width: 70%;
      margin: 50px auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1, h2 {
      color: #333;
      font-weight: 600;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 10px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 10px;
    }

    .order-section {
      margin-bottom: 30px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
    }

    input, textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #5b9bd5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    thead {
      background-color: #f2f2f2;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    th {
      background-color: #4CAF50;
      color: white;
      font-weight: 600;
    }

    td {
      color: #555;
    }

    tbody tr:hover {
      background-color: #f9f9f9;
    }

    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    button:hover {
      background-color: #45a049;
    }

    p {
      font-size: 18px;
      color: #333;
    }

    p span {
      font-weight: bold;
      color: #e74c3c;
    }
  </style>
  <!-- jQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <!-- iamport.payment.js -->
  <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>
</head>
<body>
  <div class="container">
    <h1>ì£¼ë¬¸ ì •ë³´</h1>

    <div class="order-section">
      <h2>ë°°ì†¡ ì •ë³´</h2>
      <form id="paymentForm">
        <label for="recipient">ìˆ˜ë ¹ì¸:</label>
        <input type="text" id="recipient" name="orderRecipient" th:value="${orderRecipient}" required>

        <label for="address">ì£¼ì†Œ:</label>
        <input type="text" id="address" name="orderAddress" th:value="${orderAddress}" required>

        <label for="phone">ì „í™”ë²ˆí˜¸:</label>
        <input type="tel" id="phone" name="orderPhone" th:value="${orderPhone}" required>

        <label for="request">ë°°ì†¡ ìš”ì²­ì‚¬í•­:</label>
        <textarea id="request" name="orderRequest" rows="3" cols="40" th:text="${orderRequest}"></textarea>
      </form>
    </div>

    <div class="order-section">
      <h2>ì£¼ë¬¸ ìƒí’ˆ</h2>
      <table>
        <thead>
        <tr>
          <th>ìƒí’ˆëª…</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>ê°€ê²©</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
      <hr>
      <p>ì´ ì£¼ë¬¸ ê¸ˆì•¡: <span th:text="${#numbers.formatCurrency(orderTotal)}"></span></p>
    </div>

    <div class="order-section">
      <h2>ê²°ì œ</h2>
      <button type="button" id="orderBtn">ê²°ì œí•˜ê¸°</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('jwtToken');
      axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;

      // ê²°ì œ ê¸°ëŠ¥
      var IMP = window.IMP;
      IMP.init("imp38754276");

      function requestPay() {
        IMP.request_pay(
          {
            pg: "html5_inicis",
            pay_method: "card",
            merchant_uid: "1234578",
            name: "ë‹¹ê·¼ 10kg",
            amount: 200,
            buyer_email: "gildong@gmail.com",
            buyer_name: "í™ê¸¸ë™",
            buyer_tel: "010-4242-4242",
            buyer_addr: "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‹ ì‚¬ë™",
            buyer_postcode: "01181"
          },
          function (rsp) {
            if (rsp.success) {
              $.ajax({
                  url: "/payment/validate/" + rsp.imp_uid,
                  method: 'GET',
                  contentType: 'application/json',
                  data: JSON.stringify({
                    imp_uid: rsp.imp_uid,
                    merchant_uid: rsp.merchant_uid,
                    amount: rsp.paid_amount
                  }),
                  }).done(function(data){
                  console.log(data);
                  alert("ê²°ì œ ì„±ê³µ");
<!--                  window.location.href = "/payment/success";-->
                 })
            } else {
              alert("ê²°ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤. ì—ëŸ¬ ë‚´ìš©: " + rsp.error_msg);
            }
          }
        );
      }

      // ê²°ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
      document.getElementById('orderBtn').addEventListener('click', requestPay);

      // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° SSE ì—°ê²° ì„¤ì •
      function checkLoginStatus() {
        if (token) {
          connectToNotifications(token);
          console.log(token);
        }
      }

      // SSE ì—°ê²° í•¨ìˆ˜
      function connectToNotifications(token) {
        const eventSource = new EventSource(`/users/notifications/connect?token=${token}`);

        eventSource.addEventListener('sse', function (event) {
          if (typeof event.data === 'string' && !event.data.startsWith('EventStream')) {
            let data;
            try {
              data = JSON.parse(event.data);
            } catch (e) {
              console.error('Failed to parse event data:', e);
              return;
            }

            if (data.alarmTitle) {
              alert(`[${data.alarmTitle}]ì´ ë„ì°©í–ˆì–´ìš”~~~ğŸ˜˜ \nì¿ í°í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!`);
            } else {
              console.error('alarmTitle not found in event data');
            }
          }
        });

        eventSource.onerror = function (error) {
          console.error('SSE connection error:', error);
          eventSource.close();
        };
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
      checkLoginStatus();
    });
  </script>
</body>
</html>
