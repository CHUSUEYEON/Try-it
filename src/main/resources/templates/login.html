<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
</head>
<body>
  <form id="loginForm">
    <label for="userId">User ID:</label>
    <input type="text" id="userId" name="userId" required>
    <br>
    <label for="password">Password:</label>
    <input type="password" id="password" name="password" required>
    <br>
    <button type="submit">Login</button>
  </form>

  <p id="loginResult"></p> <!-- ë¡œê·¸ì¸ ê²°ê³¼ë¥¼ ë³´ì—¬ì¤„ ê³µê°„ -->

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('loginForm').addEventListener('submit', async (event) => {
            event.preventDefault(); // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€

            // ì…ë ¥í•œ ìœ ì € IDì™€ íŒ¨ìŠ¤ì›Œë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
            const userId = document.getElementById('userId').value;
            const userPassword = document.getElementById('password').value;

            try {
                // ë¡œê·¸ì¸ ìš”ì²­ ë³´ë‚´ê¸° (POST ìš”ì²­)
                const response = await axios.post('/auth/login', { userId, userPassword });

                // ìš”ì²­ ì„±ê³µ ì‹œ ì²˜ë¦¬
                if (response.status === 200) {
                    document.getElementById('loginResult').textContent = 'Login successful!';
                    const token = response.data.data.token;
                    localStorage.setItem('jwtToken', token); // JWT í† í° ì €ì¥

                    // SSE ì—°ê²° ì‹œì‘
                    connectToNotifications();

                    // í˜ì´ì§€ ë¦¬ë””ë ‰ì…˜ ì˜ˆì‹œ
                    window.location.href = '/pages/main'; // í•„ìš” ì‹œ ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë””ë ‰ì…˜
                }
            } catch (error) {
                if (error.response) {
                    // ì„œë²„ê°€ 400ì´ë‚˜ 500ì—ëŸ¬ë¥¼ ë°˜í™˜í•œ ê²½ìš°
                    document.getElementById('loginResult').textContent = 'Login failed: ' + error.response.data.message;
                } else if (error.request) {
                    // ìš”ì²­ì´ ì„œë²„ì— ë„ë‹¬í•˜ì§€ ëª»í•œ ê²½ìš°
                    document.getElementById('loginResult').textContent = 'No response from server. Please try again later.';
                } else {
                    // ê·¸ ì™¸ ë‹¤ë¥¸ ì—ëŸ¬ê°€ ë°œìƒí•œ ê²½ìš°
                    document.getElementById('loginResult').textContent = 'An error occurred: ' + error.message;
                }
            }
        });

        // SSE ì—°ê²° í•¨ìˆ˜
        function connectToNotifications() {
            const token = localStorage.getItem('jwtToken');
            const eventSource = new EventSource(`/users/notifications/connect?token=${token}`);

            // ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ ì‹¤í–‰
            eventSource.onmessage = function(event) {
                console.log('New notification:', event.data);
                alert('New notification: ' + event.data); // ì•Œë¦¼ ë©”ì‹œì§€ ì¶œë ¥ (ì˜ˆì‹œ)
            };

            // ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°
            eventSource.addEventListener('sse', function(event) {
                console.log(event);
                console.log('New alarm notification:', event.data);
                 // event.dataê°€ ë¬¸ìì—´ì¸ì§€ í™•ì¸ í›„ startsWith ì‚¬ìš©
                if (typeof event.data === 'string' && !event.data.startsWith('EventStream')) {
                    // event.dataê°€ ê°ì²´ì¸ ê²½ìš° JSONìœ¼ë¡œ íŒŒì‹±í•˜ì—¬ alarmTitle ì ‘ê·¼
                    let data;
                    try {
                        data = JSON.parse(event.data);
                      } catch (e) {
                        console.error('Failed to parse event data:', e);
                        return;
                      }

                    // ì•Œë¦¼ ì œëª©ì„ alertë¡œ ë„ìš°ê¸°
                    if (data.alarmTitle) {
                        alert(`[${data.alarmTitle}]ì´ ë„ì°©í–ˆì–´ìš”~~~ğŸ˜˜ \nì¿ í°í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”!`);
                    } else {
                        console.error('alarmTitle not found in event data');
                    }
                }
            });

            // ì—°ê²°ì´ ë‹«í˜”ì„ ë•Œ
            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                eventSource.close(); // ì—ëŸ¬ ì‹œ SSE ì—°ê²° ë‹«ê¸°
            };
        }

        // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° SSE ì—°ê²° ì„¤ì •
        function checkLoginStatus() {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                // ë¡œê·¸ì¸ ìƒíƒœì´ë©´ SSE ì—°ê²° ì„¤ì •
                connectToNotifications();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        checkLoginStatus();
    });
  </script>
</body>
</html>
