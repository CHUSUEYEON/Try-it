<!DOCTYPE html>
<html lang="en"  xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>main</title>
</head>
<style>
  header {
    background-color: #3335;
    color: white;
    padding: 15px;
    text-align: end;
  }

  h1 {
    font-size: 24px;
    margin-top: 40px;
    text-align: center;
  }
</style>
<body>
  <header>
    <div>
      <a href="orders">주문 </a>
      <a href="coupon">쿠폰함</a>
    </div>
  </header>
  <h1> Welcome to Try-it </h1>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
<!--        const token = localStorage.getItem('jwtToken');-->
<!--        if(!token){-->
<!--         console.error("토큰이 없습니다.");-->
<!--         return;-->
<!--         }-->

<!--         axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;-->
<!--         console.log(token);-->
<!--         rendering();-->

<!--         async function rendering(){-->
<!--          try{-->
<!--            const res = await axios.get('/pages/main');-->
<!--            console.log(res.data);-->
<!--          }catch(error => {-->
<!--             console.error("메인 페이지 요청 실패 ", error);-->
<!--         });-->
    // 로그인 상태 확인 및 SSE 연결 설정
    function checkLoginStatus() {
        const token = localStorage.getItem('jwtToken');

         if (token) {
        connectToNotifications();
      }
    }

    // SSE 연결 함수
    function connectToNotifications() {
        const token = localStorage.getItem('jwtToken');
        const eventSource = new EventSource(`/users/notifications/connect?token=${token}`);

        eventSource.addEventListener('sse', function(event) {
            if (typeof event.data === 'string' && !event.data.startsWith('EventStream')) {
                let data;
                try {
                    data = JSON.parse(event.data);
                } catch (e) {
                    console.error('Failed to parse event data:', e);
                    return;
                }

                if (data.alarmTitle) {
                    alert(`[${data.alarmTitle}]이 도착했어요~~~😘 \n쿠폰함을 확인해주세요!`);
                } else {
                    console.error('alarmTitle not found in event data');
                }
            }
        });

        eventSource.onerror = function(error) {
            console.error('SSE connection error:', error);
            eventSource.close(); // 에러 시 SSE 연결 닫기
        };
    }

    // 페이지 로드 시 로그인 상태 확인
    checkLoginStatus();
});

  </script>
</body>
</html>